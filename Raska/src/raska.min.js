(function(e,t){"use strict";var n=t.querySelector.bind(t),i=function(){return e.requestAnimationFrame=function(){var t=null;return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||e.oRequestAnimationFrame||function(n){null!==t&&e.clearTimeout(t),t=e.setTimeout(n,h.frameRefreshRate)}}(),{$dom:function(){var r=function(t){return i.$obj.is(t.raw,"function")&&(t=t.raw()),{css:function(e,n){if(i.$obj.isType(e,"string")){if(i.$obj.isUndefined(n))return t.style[e];if(""===n)return r(t).removeCss(e);t.style[e]=n}else for(var o in e)r(t).css(o,e[o]);return r(t)},removeCss:function(e){return t.style.removeProperty?t.style.removeProperty(e):t.style[e]="",r(t)},attr:function(e,n){if(i.$obj.isType(e,"string")){if(i.$obj.isUndefined(n))return t.getAttribute(e);t.setAttribute(e,n)}else for(var o in e)r(t).attr(o,e[o]);return r(t)},raw:function(){return t},getXYPositionFrom:function(e){i.$device.isTouch&&i.$obj.is(e.touches.length,"number")&&e.touches.length>0&&(e=e.touches[0]);var n=t.getBoundingClientRect();return{x:(e.clientX-n.left)*(t.width/n.width),y:(e.clientY-n.top)*(t.height/n.height)}},addChild:function(e){if(i.$obj.isType(e,"string")){var n=o.create(e);return t.appendChild(n.raw()),n}return t.appendChild(e),r(e)},type:function(){return t.nodeName},getParent:function(){return r(t.parentElement?t.parentElement:t.parentNode)},addSibling:function(e){return r(t).getParent().addChild(e)},html:function(e){return i.$obj.isType(e,"string")?(t.innerHTML=e,r(t)):t.innerHTML},text:function(e){return i.$obj.isType(e,"string")?(t.innerText=e,r(t)):t.innerText},on:function(n,i){return e.addEventListener?t.addEventListener(n,i,!1):e.attachEvent?t.attachEvent("on"+n,i):t["on"+n]=i,r(t)},first:function(e){var n=t.querySelectorAll(":scope > "+e);return i.$obj.isType(n,"nodelist")?r(n[0]):null}}},o={create:function(e,n){var o=t.createElement(e);return o.id=i.$obj.generateId(),i.$obj.isValid(n)&&r(n).addChild(o),r(o)},get:function(e){var t=i.$obj.isType(e,"string")?n(e):e;return r(t)},getById:function(e){return r(n("#"+e))}};return o}(),$device:function(){var t="ontouchstart"in e&&null!==e.ontouchstart||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0,n={isTouch:t,gathersXYPositionFrom:function(e,t){return i.$dom.get(e).getXYPositionFrom(t)},on:function(e,t,r){return i.$dom.get(e).on(t,r),n}};return n}(),$log:{active:!1,info:function(e,t){this.active===!0&&console.info(e,t)}},$obj:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function t(e,n){for(var i,r,o=0;o<e.length;o++){if(i=e[o],!(i.graphNode!==!0||null!==(r=i.getLinksFrom())&&0!==r.length||null!==(r=i.getLinksTo())&&0!==r.length))throw new u.errors.elementDoesNotHaveALink(i.name);i.isSerializable()&&(n.push(i.normalize()),t(i.getChildElements(),n))}}var n;return n={forEach:function(e,t){var i=[];if(n.isArray(e))for(var r=0;r<e.length;r++)i.push(t(e[r],r));return i},is:function(e,t){return typeof e===t},isType:function(e,t){return this.isValid(e)&&Object.prototype.toString.call(e).toLowerCase()==="[object "+t.toLowerCase()+"]"},generateId:function(){return"__"+e()+e()+e()+e()+e()+e()+e()+e()},isValid:function(e){return!this.is(e,"undefined")&&null!==e},isArray:function(e){return this.isValid(e)&&this.isType(e,"Array")},isUndefined:function(e){return this.is(e,"undefined")},deconstruct:function(e){var n=[];return i.$obj.isArray(e)&&t(e,n),JSON.stringify(n)},recreate:function(e){if(this.isValid(e.type)&&e.type in s){var t=this.extend(new u[e.type],e);return t.getType=function(){return e.type},t}return null},recreateLinks:function(e,t,n){this.forEach(this.forEach(t.linksTo,n),e.addLinkTo.bind(e)),this.forEach(this.forEach(t.childElements,n),e.addChild.bind(e)),null!==t.parent&&n(t.parent).addChild(e)},extend:function(e,t,n){var i={},r=null;if(this.isUndefined(t))for(r in e)i[r]=e[r];else{n===!0&&(i=t);for(r in e)i.hasOwnProperty(r)||(i[r]=t.hasOwnProperty(r)?t[r]:e[r])}return i}}}()}}(),r=function(e,t,n){var o=t||null,s=[];this.element=e,this.hasParent=function(e){return null!==o&&(o.element===e||o.getName()===e.name||o.hasParent(e))},this.getParentGraphNodeFor=function(e){return this.element===e||this.getName()===e.name?this:null!==o?this.getParent(e):null},this.getName=function(){return e.name},this.getParent=function(){return o},this.getLinks=function(){return s};for(var a=0;a<n.length;a++)n[a].graphNode===!0&&(this.hasParent(n[a])?i.$log.info("ingored parent node",this.getParentGraphNodeFor(n[a])):s.push(new r(n[a],this,n[a].getLinksTo())))},o={relative:0,absolute:1},s={basic:"basic",html:"htmlElement",arrow:"arrow",circle:"circle",square:"square",label:"label",triangle:"triangle"},a=function(){function e(e,t){for(var n=0;n<e.length;n++)t(e[n]);return[]}var t,n=i.$dom.create("canvas").attr({width:"1",height:"1"}),r=n.raw().getContext("2d"),a=function(){},l=!1,h=null,c=[],d=[],f=null,g=null,m=[],v=[];return t={attr:{},name:"anonymous",getType:function(){return s.basic},graphNode:!0,canLink:function(e,t){return e!==this||i.$obj.isValid(t)&&t.canReach(this)===!1},canBeMoved:function(){return!0},disable:function(){return l=!0,i.$obj.forEach(v,function(e){i.$obj.is(e,"function")?e(this):e.elementDisabledNotification(this)}.bind(this)),v.length=0,this.clearAllLinks(),i.$obj.forEach(m,function(e){e.disable()}),m.length=0,this.drawTo=a,this},notifyDisableStateOn:function(e){return v.indexOf(e)===-1&&(i.$obj.isValid(e.elementDisabledNotification)||i.$obj.is(e,"function"))&&v.push(e),this},elementDisabledNotification:function(e){return this},canReach:function(e){if(c.length>0)for(var t=0;t<c.length;t++)if(c[t].canReach(e))return!0;return this===e},isLinkable:function(){return!l},isSerializable:function(){return!l},addLinkTo:function(e){return!!(i.$obj.isValid(e.isLinkable)&&e.isLinkable()&&this.isLinkable()&&c.indexOf(e)===-1&&e!==this&&this.canLink(this,e))&&(c.push(e),e.addLinkFrom(this),!0)},addLinkFrom:function(e){return!!(i.$obj.isValid(e.isLinkable)&&e.isLinkable()&&this.isLinkable()&&d.indexOf(e)===-1&&e!==this&&this.canLink(e,this))&&(d.push(e),e.addLinkTo(this),!0)},removeLinkTo:function(e){return c.indexOf(e)>-1&&(c.splice(c.indexOf(e),1),i.$obj.isType(f,"function")===!0&&f.call(this,e),e.removeLinkFrom(this)),this},beforeRemoveLinkFrom:function(e){return f=e,this},normalize:function(){var e=function(e){return e.name},t=i.$obj.extend(this,{linksTo:i.$obj.forEach(this.getLinksTo(),e),childElements:i.$obj.forEach(this.getChildElements(),e),parent:i.$obj.isValid(h)?h.name:null,type:this.getType()},!0);return delete t.on,t},getLinksTo:function(){return c},getLinksFrom:function(){return d},removeLinkFrom:function(e){return d.indexOf(e)>-1&&(d.splice(d.indexOf(e),1),i.$obj.isType(g,"function")===!0&&g.call(this,e),e.removeLinkTo(this)),this},beforeRemoveLinkTo:function(e){return g=e,this},clearAllLinks:function(){return c=e(c,function(e){e.removeLinkFrom(this)}.bind(this)),d=e(d,function(e){e.removeLinkTo(this)}.bind(this)),this},getChildElements:function(){return m},addChild:function(e){return e.setParent(this),m.push(e),this},getParent:function(){return h},getBoundaries:function(){return{x:this.getWidth(),y:this.getHeight(),minX:0,minY:0}},setParent:function(e){return h=e,this},border:{color:null,whenMoving:null,whenLinking:null,active:!1,width:0},position:o.relative,x:50,y:50,getAdjustedCoordinates:function(){if(this.position===o.relative&&null!==h){var e=h.getAdjustedCoordinates();return{x:this.x+e.x,y:this.y+e.y}}return{x:this.x,y:this.y}},canHandleEvents:function(){return!0},on:function(){function e(e,t,n,r,o){i.$obj.forEach(o,function(i){i(e,t,n,r)})}var n=[],r=[];return{click:function(r,o,s,a){if(i.$obj.isType(r,"number")===!0){var l=!1;if(m.length>0){var u=s.getAdjustedCoordinates();i.$obj.forEach(m,function(e){var t={x:r-u.x,y:o-u.y};e.canHandleEvents()&&e.existsIn(t.x,t.y)&&(e.on.click(t.x,t.y,e,a),l=!0)})}l===!1&&e(r,o,s,a,n)}else i.$obj.isType(r,"function")===!0&&n.push(r);return t},release:function(n,o,s,a){if(i.$obj.isType(n,"number")===!0){var l=!1;if(m.length>0){var u=s.getAdjustedCoordinates();i.$obj.forEach(m,function(e){var t={x:n-u.x,y:o-u.y};e.canHandleEvents()&&e.existsIn(t.x,t.y)&&(e.on.release(t.x,t.y,e,a),l=!0)})}l===!1&&e(n,o,s,a,r)}else i.$obj.isType(n,"function")===!0&&r.push(n);return t}}}(),existsIn:function(e,t){r.setTransform(1,0,0,1,-e,-t),this.drawTo(n,r);var i=!1;try{i=r.getImageData(0,0,1,1).data[3]>1}catch(e){}return r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,2,2),i},adjustPosition:function(e,t){throw console.error(u.errors.notImplementedException),u.errors.notImplementedException},setWidth:function(e){throw console.error(u.errors.notImplementedException),u.errors.notImplementedException},getWidth:function(){throw console.error(u.errors.notImplementedException),u.errors.notImplementedException},getAdjustedWidth:function(){return this.getWidth()},setHeight:function(e){throw console.error(u.errors.notImplementedException),u.errors.notImplementedException},getHeight:function(){throw console.error(u.errors.notImplementedException),u.errors.notImplementedException},getAdjustedHeight:function(){return this.getHeight()},drawTo:function(e,t){throw console.error(u.errors.notImplementedException),u.errors.notImplementedException}}},l=function(){var e=!1,n={container:{width:0,height:0,position:0,"z-index":0,left:0,top:0},canvas:{width:0,height:0}};return{toggleFullScreen:function(r,o){var s=i.$dom.getById(h.targetCanvasContainerId),a=i.$dom.get(r),l=o?40:0;if(e===!1){for(var u in n.container)n.container[u]=s.css(u);var c=document.body.clientHeight-l;s.css({width:t.body.clientWidth,height:c,position:"fixed","z-index":1e3,"background-color":"white",left:0,top:0});for(var u in n.canvas)n.canvas[u]=a.attr(u);a.attr({width:t.body.clientWidth,height:c}),i.$obj.isValid(o)&&i.$dom.getById(o).first("button").html("<span class='glyphicon glyphicon-resize-small'></span>&nbsp;Back to normal"),e=!0}else{for(var u in n.container)s.css(u,n.container[u]);for(var u in n.canvas)a.attr(u,n.canvas[u]);i.$obj.isValid(o)&&i.$dom.getById(o).first("button").html("<span class='glyphicon glyphicon-resize-full'></span>&nbsp;Fullscreen"),e=!1}}}}(),u={library:{readonly:!1,frameRefreshRate:30,targetCanvasId:"",targetCanvasContainerId:"____raska"+i.$obj.generateId(),toolboxButtons:[{id:"",name:"fullscreen",enabled:!0,onclick:function(e){l.toggleFullScreen(e,this.id)},template:"<button class='btn btn-primary btn-sm'><span class='glyphicon glyphicon-resize-full'></span>&nbsp;Fullscreen</button>"}]},errors:{notImplementedException:{message:"Not implemented",code:0},nullParameterException:function(e){if("undefined"==typeof e||null===e)throw new this.nullParameterException("parameterName");this.message="Parameter can't be null",this.parameterName=e,this.code=1},elementDoesNotHaveALink:function(e){if("undefined"==typeof e||null===e)throw new this.nullParameterException("elementName");return{message:"Element '"+e+"' doesn't have a valid linked sibling",elementName:e,code:2}},itemNotFoundException:function(e){if("undefined"==typeof e||null===e)throw new this.nullParameterException("elementName");return{message:"Element '"+e+"' wasn't found",elementName:e,code:3}}},label:function(){return i.$obj.extend(new a,{name:"label"+i.$obj.generateId(),graphNode:!1,getType:function(){return s.label},canLink:function(){return!1},isLinkable:function(){return!1},text:"",color:"gray",x:0,y:0,border:{color:"white",active:!0,width:2},font:{family:"Arial",size:"12px",decoration:""},getWidth:function(){return 5*this.text.length},getHeight:function(){return this.font.size},drawTo:function(e,t){var n=this.getAdjustedCoordinates();t.save(),t.font=(this.font.decoration||"")+" "+this.font.size+" "+this.font.family,this.border.active===!0&&(t.lineJoin="round",t.lineWidth=this.border.width,t.strokeStyle=this.border.color,t.strokeText(this.text,n.x,n.y)),t.fillStyle=this.color,t.fillText(this.text,n.x,n.y),t.restore()},existsIn:function(e,t){return!1}},!0)},square:function(e){var t=e||{width:50,height:50};return i.$obj.extend(new a,{name:"square"+i.$obj.generateId(),getType:function(){return s.square},border:{color:"gray",active:!0,width:2},fillColor:"silver",dimensions:t,globalAlpha:1,getWidth:function(){return this.dimensions.width},getHeight:function(){return this.dimensions.height},drawTo:function(e,t){var n=this.getAdjustedCoordinates();t.beginPath(),t.rect(n.x,n.y,this.dimensions.width,this.dimensions.height),t.fillStyle=this.fillColor,this.border.active===!0&&(t.lineWidth=this.border.width,t.strokeStyle=this.border.color),t.globalAlpha=this.globalAlpha,t.fill(),t.stroke()},existsIn:function(e,t){return e>=this.x&&e<=this.x+this.dimensions.width&&t>=this.y&&t<=this.y+this.dimensions.height},adjustPosition:function(e,t){var n=this.getParent();if(this.position===o.relative&&null!==n){var i=n.getAdjustedCoordinates(),r=n.getWidth()/2,s=n.getHeight()/2,a=e-i.x-r,l=t-i.y-s;this.x=a<0?Math.max(a,r*-1):Math.min(a,r),this.y=l<0?Math.max(l,s*-1):Math.min(l,s)}else this.x=e,this.y=t;return this}},!0)},arrow:function(e){if(i.$obj.isUndefined(e)||null===e)throw new u.errors.nullParameterException("target");var t=e,n=function(e,t,n,i,r,o,s){e.fillStyle=s,e.save(),e.beginPath(),e.translate(t,n),e.rotate(i),e.moveTo(0,-10),e.lineTo(o,r),e.lineTo(o*-1,r),e.closePath(),e.restore(),e.fill()};return i.$obj.extend(new a,{name:"arrow"+i.$obj.generateId(),clearAllLinks:function(){return i.$obj.isValid(this.getParent())&&i.$obj.is(this.getParent().removeLinkFrom,"function")&&i.$obj.is(t.removeLinkTo,"function")&&(this.getParent().removeLinkFrom(t).removeLinkTo(t),t.removeLinkFrom(this.getParent()).removeLinkTo(this.getParent())),this},elementDisabledNotification:function(e){e!==t&&e!==this.getParent()||this.disable()},graphNode:!1,canHandleEvents:function(){return!1},isSerializable:function(){return!1},getType:function(){return s.arrow},canLink:function(){return!1},isLinkable:function(){return!1},border:{color:"gray",active:!0,width:2},fillColor:"rgba(0,0,0,0.3)",getWidth:function(){return 1},getHeight:function(){return 1},drawTo:function(e,r){i.$obj.isValid(t.notifyDisableStateOn)&&t.notifyDisableStateOn(this),i.$obj.isValid(this.getParent().notifyDisableStateOn)&&this.getParent().notifyDisableStateOn(this);var o=t.getAdjustedCoordinates?t.getAdjustedCoordinates():{x:t.x,y:t.y},s=this.getParent(),a=s.getAdjustedCoordinates(),l=a.x+(s.getAdjustedWidth?s.getAdjustedWidth()/2:0),u=a.y+(s.getAdjustedHeight?s.getAdjustedHeight()/2:0);if(this.x=o.x+(t.getAdjustedWidth?t.getAdjustedWidth()/2:0),this.y=o.y+(t.getAdjustedHeight?t.getAdjustedHeight()/2:0),r.beginPath(),r.fillStyle=this.fillColor,this.border.active===!0){var h=r.createLinearGradient(this.x,this.y,l,u);h.addColorStop(0,this.border.color),h.addColorStop(.5,this.fillColor),h.addColorStop(1,this.border.color),r.lineWidth=this.border.width,r.strokeStyle=h}r.moveTo(this.x,this.y),r.lineTo(l,u),r.stroke();var c=Math.atan((u-this.y)/(l-this.x));c+=(l>this.x?-90:90)*Math.PI/180,n(r,this.x,this.y,c,5,8,this.fillColor),this.border.active===!0?n(r,this.x,this.y,c,3,5,this.border.color):n(r,this.x,this.y,c,3,5,"white")}},!0)},htmlElement:function(e){if(!i.$obj.isValid(e)){var t=new u.errors.nullParameterException("element");throw console.error(t.message),t}var n=e;return i.$obj.extend(new a,{name:"htmlElement"+i.$obj.generateId(),canHandleEvents:function(){return!1},getType:function(){return s.html},graphNode:!1,isSerializable:function(){return!1},canLink:function(){return!1},isLinkable:function(){return!1},border:{active:!1},fillColor:"",getWidth:function(){return e.clientWidth},getHeight:function(){return e.clientHeight},drawTo:function(e,t){},existsIn:function(e,t){return!1},handleInteractions:!0,onIteraction:function(e,t){var r=function(i){t(i,n,e)};i.$device.on(n,e,r)}},!0)},triangle:function(e){var t={p2:{x:0,y:0},p3:{x:0,y:0}};return i.$obj.extend(new a,{name:"triangle"+i.$obj.generateId(),border:{color:"gray",active:!0,width:2},getType:function(){return s.triangle},fillColor:"silver",pointingUp:e!==!1,dimensions:{width:50,height:50},setWidth:function(e){return this.dimensions.width=e,this},getWidth:function(){return this.dimensions.width},setHeight:function(e){return this.dimensions.height=e,this},getAdjustedHeight:function(){return this.pointingUp===!0?this.dimensions.height*-1:this.dimensions.height/2},getHeight:function(){return this.dimensions.height},drawTo:function(e,n){var i=this.pointingUp===!1?function(e,t){return e+t}:function(e,t){return e-t},r=this.getAdjustedCoordinates();n.beginPath(),n.fillStyle=this.fillColor,n.moveTo(r.x,r.y),n.lineTo(t.p2.x=r.x+this.dimensions.width/2,t.p2.y=i(r.y,this.dimensions.height)),n.lineTo(t.p3.x=r.x+this.dimensions.width,t.p3.y=r.y),n.closePath(),this.border.active===!0&&(n.lineWidth=this.border.width,n.strokeStyle=this.border.color),n.fill(),n.stroke()},existsIn:function(e,n){var i=this.getAdjustedCoordinates(),r=i,o=t.p2,s=t.p3,a={x:e,y:n},l=((o.y-s.y)*(a.x-s.x)+(s.x-o.x)*(a.y-s.y))/((o.y-s.y)*(r.x-s.x)+(s.x-o.x)*(r.y-s.y)),u=((s.y-r.y)*(a.x-s.x)+(r.x-s.x)*(a.y-s.y))/((o.y-s.y)*(r.x-s.x)+(s.x-o.x)*(r.y-s.y)),h=1-l-u;return l>0&&u>0&&h>0},adjustPosition:function(e,t){var n=this.getParent();if(this.position===o.relative&&null!==n){var i=n.getAdjustedCoordinates(),r=n.getWidth()/2,s=n.getHeight()/2,a=e-i.x-r,l=t-i.y-s;this.x=a<0?Math.max(a,r*-1):Math.min(a,r),this.y=l<0?Math.max(l,s*-1):Math.min(l,s)}else this.x=e,this.y=t;return this}},!0)},circle:function(){return i.$obj.extend(new a,{name:"circle"+i.$obj.generateId(),border:{color:"gray",active:!0,width:2},getType:function(){return s.circle},fillColor:"silver",radius:20,setWidth:function(e){return this.radius=e/2,this},getWidth:function(){return 2*this.radius},getAdjustedWidth:function(){return this.radius/2},setHeight:function(e){return this.radius=e/2,this},getAdjustedHeight:function(){return this.radius/2},getHeight:function(){return 2*this.radius},drawTo:function(e,t){var n=this.getAdjustedCoordinates();t.beginPath(),t.arc(n.x,n.y,this.radius,0,2*Math.PI,!1),t.fillStyle=this.fillColor,t.fill(),this.border.active===!0&&(t.lineWidth=this.border.width,t.strokeStyle=this.border.color,t.stroke())},existsIn:function(e,t){var n=this.x-e,i=this.y-t;return n*n+i*i<this.radius*this.radius},getBoundaries:function(){var e=this.radius/2;return{x:e,y:e,minX:e*-1,minY:e*-1}},adjustPosition:function(e,t){var n=this.getParent();if(this.position===o.relative&&null!==n){var i=n.getAdjustedCoordinates(),r=n.getBoundaries(),s=r.x,a=r.y,l=e-i.x-s,u=t-i.y-a;this.x=l<0?Math.max(l,r.minX):Math.min(l,s),this.y=u<0?Math.max(u,r.minY):Math.min(u,a)}else this.x=e,this.y=t;return this}},!0)}},h=null,c=function(){var e={click:0,mousemove:1},t=function(e){return function(t,n,i){e({x:d.mouseHelper.getX(t),y:d.mouseHelper.getY(t),details:{interactionType:i,targetElement:n}})}};return{getInteractionTypes:e,register:function(n,r,o){r in e&&i.$obj.isValid(n)&&n.handleInteractions===!0&&n.onIteraction(r,t(o))}}}(),d=function(){var t=[],o=!1,s=null,a=null,l=null,c=function(){o===!0&&(j(),e.requestAnimationFrame(c))},d=function(e){e.drawTo(s,l);for(var t=e.getChildElements(),n=0;n<t.length;n++)d(t[n])},f={getX:function(e){return i.$device.gathersXYPositionFrom(s,e).x},getY:function(e){return i.$device.gathersXYPositionFrom(s,e).y},staticCoordinates:function(){var e={clientX:0,clientY:0},t=!1;return{getXY:function(){return t||(s.onmousemove=function(t){e.clientX=t.clientX,e.clientY=t.clientY+30},t=!0),{x:f.getX(e),y:f.getY(e)}}}}()},g={reference:null,holdingCTRL:!1,originalBorder:{},dragTypes:{moving:1,linking:3},dragType:0,temporaryLinkArrow:function(){return{tryRender:function(){if(null!==g.reference&&g.dragType===g.dragTypes.linking&&g.reference.isLinkable()===!0){var e=f.staticCoordinates.getXY(),t=new u.arrow({x:e.x,y:e.y-30,getHeight:function(){return 0}});t.name="_temp",t.setParent(g.reference),t.drawTo(s,l)}return this}}}(),border:{whenMoving:{color:"yellow",active:!0},whenLinking:{color:"green",active:!0}}},m=function(e){null!==g.reference&&g.reference.canBeMoved()===!0&&g.dragType===g.dragTypes.moving&&(i.$log.info("Moving element",g),g.reference.x=f.getX(e),g.reference.y=f.getY(e))},v=function(e){if(null!==g.reference){if(g.dragType===g.dragTypes.linking)for(var n=0;n<t.length;n++)if(t[n]!==g.reference&&t[n].existsIn(f.getX(e),f.getY(e))&&g.reference.addLinkTo(t[n])){t.push(new u.arrow(t[n]).setParent(g.reference));break}g.reference.on.release(f.getX(e),f.getY(e),g.reference,e),g.reference.border=g.originalBorder,g.reference=null}},y=function(e){return i.$log.info("Removing element",e),e.disable(),t.splice(t.indexOf(e),1),this},b=function(e){return i.$log.info("Adding element",e),t.push(e),this},p=function(e){return g.holdingCTRL=!1,this},x=function(e){var t=e.keyCode||e.charCode;return 46!==t&&8!==t||null===g.reference?g.holdingCTRL=17===t:(y(g.reference.clearAllLinks()),g.reference=null),this},w=function(n){n=n||e.event;for(var r=0;r<t.length;r++)t[r].existsIn(f.getX(n),f.getY(n))&&(g.reference=t[r]).canHandleEvents()&&g.reference.on.click(f.getX(n),f.getY(n),g.reference,n);if(null!==g.reference){var o=g.dragTypes.moving;i.$device.isTouch||(o=g.holdingCTRL===!0&&g.reference.isLinkable()===!0?g.dragTypes.linking:n.which),g.originalBorder=g.reference.border,g.reference.border=(g.dragType=o)===g.dragTypes.moving?g.reference.border.whenMoving||g.border.whenMoving:g.reference.border.whenLinking||g.border.whenLinking,i.$log.info("Dragging element",{r:g.reference,d:o})}return n.preventDefault?n.preventDefault():n.returnValue&&(n.returnValue=!1),!1},j=function(){if(null===s){if(l=(s=n("#"+h.targetCanvasId)).getContext("2d"),i.$dom.get(s).on("mousedown",w).on("mousemove",m).on("contextmenu",function(e){return e.preventDefault(),!1}),i.$obj.isArray(h.toolboxButtons)){var r=i.$dom.get(s);r.getParent().attr("id")!==h.targetCanvasContainerId&&r.getParent().addChild("div").attr("id",h.targetCanvasContainerId).addChild(r.raw()),i.$obj.forEach(h.toolboxButtons,function(e){r.addSibling("div").attr("id",e.id=i.$obj.generateId()).html(e.template).on("click",function(){e.onclick(s)})})}i.$dom.get(e).on("mouseup",v).on("keydown",x).on("keyup",p),i.$device.isTouch===!0&&(i.$dom.get(s).on("touchstart",w).on("touchmove",m),i.$dom.get(e).on("touchend",v).on("touchcancel",v)),a=i.$obj.extend(new u.htmlElement(s),{})}l.clearRect(0,0,s.width,s.height);for(var o=0;o<t.length;o++)d(t[o]);return g.temporaryLinkArrow.tryRender(),this},$=function(){for(var e,n,i={},o=0;o<t.length;o++)if(e=t[o],e.graphNode===!0){if(!(null!==(n=e.getLinksFrom())&&0!==n.length||null!==(n=e.getLinksTo())&&0!==n.length))throw new u.errors.elementDoesNotHaveALink(e.name);i[e.name]=new r(e,null,e.getLinksTo())}return i};return{mouseHelper:f,addElement:function(e){return b(e),this},getDataUrl:function(e){if(e===!0){for(var t=i.$dom.create("canvas").raw(),n=t.getContext("2d"),r=function(e,t){return e-t},o=s.width,a=s.height,u={x:[],y:[]},h=l.getImageData(0,0,o,a),c=0,d=0;d<a;d++)for(var f=0;f<o;f++)c=4*(d*o+f),h.data[c+3]>0&&(u.x.push(f),u.y.push(d));u.x.sort(r),u.y.sort(r);var g=u.x.length-1;o=u.x[g]-u.x[0],a=u.y[g]-u.y[0];var m=l.getImageData(u.x[0],u.y[0],o,a);return t.width=o,t.height=a,n.putImageData(m,0,0),t.toDataURL()}return s.toDataURL()},remove:function(e){return y(e),this},getElementsSlim:function(){return $()},getElements:function(){return t},reloadUsing:function(e){t=e,this.initializeTimedDrawing()},getCanvasElement:function(){return a},getCanvas:function(){return s},initializeTimedDrawing:function(){o===!1&&(o=!0,c())}}}(),f={newLabel:function(e){return i.$obj.extend(new u.label,e)},newSquare:function(){return i.$obj.extend(new u.square,{})},newTriangle:function(e){return i.$obj.extend(new u.triangle(e),{})},newCircle:function(){return i.$obj.extend(new u.circle,{})},plot:function(e){return d.addElement(e),f},exportImage:function(t){return e.open(d.getDataUrl(t),"_blank"),f},getElementsRaw:function(){return d.getElements()},getElementsSlim:function(){return d.getElementsSlim()},getElementsString:function(){return i.$obj.deconstruct(d.getElements())},loadElementsFrom:function(e){var t=JSON.parse(e);if(i.$obj.isArray(t)){var n=[],r=[],o=0,s=null;for(o=0;o<t.length;o++){if(null===(s=i.$obj.recreate(t[o])))return alert("Invalid JSON. See the console for more info"),console.error("Could not deserialize this element",t[o]),this;null===t[o].parent?(s.originalIndex=o,n.push(s)):r.push(s)}var a=function(e){function t(t){for(var n=0;n<t.length;n++)if(t[n].name===e)return t[n]}if(!i.$obj.isValid(e))return null;var o=t(n)||t(r);if(!o)throw u.errors.itemNotFoundException(e);return o};for(o=0;o<n.length;o++)i.$obj.recreateLinks(n[o],t[n[o].originalIndex],a),delete n[o].originalIndex;var l,h=[];for(o=0;o<n.length;o++)if(l=n[o],l.isLinkable()===!0&&(h=l.getLinksTo()).length>0)for(var c=0;c<h.length;c++)n.push(new u.arrow(h[c]).setParent(l));d.reloadUsing(n)}return this},toggleFullScreen:function(){return l.toggleFullScreen(d.getCanvas()),f},positionTypes:function(){return o}(),installUsing:function(e){return h=i.$obj.extend(u.library,e),d.initializeTimedDrawing(),f},onCanvasInteraction:function(e,t){return c.register(d.getCanvasElement(),e,t),this},checkCollisionOn:function(e,t){return null!==f.tryGetElementOn(e,t)},tryGetElementOn:function(e,t){for(var n=d.getElements(),i=0;i<n.length;i++)if(n[i].existsIn(e,t)===!0)return n[i];return null},remove:function(e){return d.remove(e),this},getCanvasBoundaries:function(){var e=d.getCanvasElement();return{maxH:e.getHeight(),maxW:e.getWidth()}},clear:function(){return d.reloadUsing([]),this},$$:{$h:i,$q:n,$c:h}};e.raska=f})(window,document);