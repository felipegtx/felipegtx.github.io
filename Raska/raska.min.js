!function(e){"use strict";var t=function(){return{$log:{active:!1,info:function(e,t){this.active===!0&&console.info(e,t)}},$obj:function(){return{is:function(e,t){return typeof e===t},isUndefined:function(e){return this.is(e,"undefined")},extend:function(e,t,n){var r={},i=null;if(this.isUndefined(t))for(i in e)r[i]=e[i];else{n===!0&&(r=t);for(i in e)r.hasOwnProperty(i)||(r[i]=t.hasOwnProperty(i)?t[i]:e[i])}return r}}}()}}(),n={relative:0,absolute:1},r=function(){function e(e,t){for(var n=0;n<e.length;n++)t(e[n]);return[]}var t=null,r=[],o=[],l=[];return{name:"anonymous",addLinkTo:function(e){return-1===r.indexOf(e)&&(r.push(e),e.addLinkFrom(this)),this},removeLinkTo:function(e){return r.splice(r.indexOf(e),1),this},getLinksTo:function(){return r},addLinkFrom:function(e){return-1===o.indexOf(e)&&(o.push(e),e.addLinkTo(this)),this},getLinksFrom:function(){return o},removeLinkFrom:function(e){return o.splice(o.indexOf(e),1),this},clearAllLinks:function(){return r=e(r,function(e){e.removeLinkFrom(this)}),o=e(o,function(e){e.removeLinkTo(this)}),this},getChildElements:function(){return l},addChild:function(e){return e.setParent(this),l.push(e),this},getParent:function(){return t},setParent:function(e){return t=e,this},border:{color:null,active:!1,width:0},position:n.relative,x:50,y:50,getAdjustedCoordinates:function(){if(this.position===n.relative&&null!==t){var e=t.getAdjustedCoordinates();return{x:this.x+e.x,y:this.y+e.y}}return{x:this.x,y:this.y}},getWidth:function(){throw console.error(i.errors.notImplementedException),i.errors.notImplementedException},getHeight:function(){throw console.error(i.errors.notImplementedException),i.errors.notImplementedException},existsIn:function(){throw console.error(i.errors.notImplementedException),i.errors.notImplementedException},drawTo:function(){throw console.error(i.errors.notImplementedException),i.errors.notImplementedException}}},i={library:{readonly:!1,frameRefreshRate:20,targetCanvasId:""},errors:{notImplementedException:{message:"Not implemented",code:0}},label:function(){return t.$obj.extend(new r,{name:"label",text:"",color:"white",x:0,y:0,border:{color:"red",active:!0,width:4},font:{family:"Tahoma",size:"12px"},getWidth:function(){return 5*this.text.length},getHeight:function(){return this.font.size},drawTo:function(e,t){var n=this.getAdjustedCoordinates();t.font=this.font.size+" "+this.font.family,t.textBaseline="middle",t.textAlign="center",this.border.active===!0&&(t.lineJoin="round",t.lineWidth=this.border.width,t.strokeStyle=this.border.color,t.strokeText(this.text,n.x,n.y)),t.fillStyle=this.color,t.fillText(this.text,n.x,n.y)},existsIn:function(){return!1}},!0)},square:function(){return t.$obj.extend(new r,{name:"square",border:{color:"gray",active:!0,width:4},fillColor:"silver",dimensions:{width:30,height:50},globalAlpha:1,getWidth:function(){return this.dimensions.width},getHeight:function(){return this.dimensions.height},drawTo:function(e,t){var n=this.getAdjustedCoordinates();t.beginPath(),t.rect(n.x,n.y,this.dimensions.width,this.dimensions.height),t.fillStyle=this.fillColor,this.border.active===!0&&(t.lineWidth=this.border.width,t.strokeStyle=this.border.color),t.globalAlpha=this.globalAlpha,t.fill(),t.stroke()},existsIn:function(e,t){return e>this.x-this.dimensions.width&&e<this.x+this.dimensions.width&&t>this.y-this.dimensions.height&&t<this.y+this.dimensions.height}},!0)},arrow:function(){var e=function(e,t,n,r,i){e.save(),e.beginPath(),e.fillStyle=i,e.strokeStyle=i,e.translate(t,n),e.rotate(r),e.moveTo(0,0),e.lineTo(5,20),e.lineTo(-5,20),e.closePath(),e.restore(),e.fill()};return t.$obj.extend(new r,{name:"arrow",border:{color:"black",active:!0,width:1},fillColor:"green",getWidth:function(){return 1},getHeight:function(){return 1},drawTo:function(t,n){var r=this.getParent();n.beginPath(),n.fillStyle=this.fillColor,this.border.active===!0&&(n.lineWidth=this.border.width,n.strokeStyle=this.border.color),n.moveTo(this.x,this.y),n.lineTo(r.x,r.y),n.stroke();var i=Math.atan((r.y-this.y)/(r.x-this.x));i+=(r.x>this.x?-90:90)*Math.PI/180,e(n,this.x,this.y,i)},existsIn:function(){return!1}},!0)},circle:function(){return t.$obj.extend(new r,{name:"circle",border:{color:"red",active:!0,width:4},fillColor:"black",radius:20,getWidth:function(){return 2*this.radius},getHeight:function(){return 2*this.radius},drawTo:function(e,t){var n=this.getAdjustedCoordinates();t.beginPath(),t.arc(n.x,n.y,this.radius,0,2*Math.PI,!1),t.fillStyle=this.fillColor,t.fill(),this.border.active===!0&&(t.lineWidth=this.border.width,t.strokeStyle=this.border.color),t.stroke()},existsIn:function(e,t){var n=this.x-e,r=this.y-t;return n*n+r*r<this.radius*this.radius}},!0)}},o=null,l=function(){var n=[],r=null,l=!1,s=null,d=null,u=function(){null!==r&&e.clearTimeout(r),l===!0&&(r=e.setTimeout(function(){p(),u()},o.frameRefreshRate))},a=function(e){e.drawTo(s,d);var t=e.getChildElements(),n=0;for(n=0;n<t.length;n++)t[n].drawTo(s,d);var r=e.getLinksFrom(),o=null;for(n=0;n<r.length;n++)o=new i.arrow,o.setParent(r[n]),o.x=e.x,o.y=e.y,o.drawTo(s,d)},h={getX:function(e){var t=s.getBoundingClientRect();return(e.clientX-t.left)*(s.width/t.width)},getY:function(e){var t=s.getBoundingClientRect();return(e.clientY-t.top)*(s.height/t.height)}},c={reference:null,holdingCTRL:!1,originalBorder:{},dragTypes:{moving:1,linking:3},dragType:0,border:{whenMoving:{color:"yellow",active:!0},whenLiking:{color:"green",active:!0}}},f=function(e){null!==c.reference&&(t.$log.info("Moving element",c),c.reference.x=h.getX(e),c.reference.y=h.getY(e))},g=function(e){if(null!==c.reference){if(c.dragType===c.dragTypes.linking)for(var t=0;t<n.length;t++)if(n[t]!==c.reference&&n[t].existsIn(h.getX(e),h.getY(e))){n[t].addLinkFrom(c.reference);break}c.reference.border=c.originalBorder,c.reference=null}},m=function(e){t.$log.info("Removing element",e),n.splice(n.indexOf(e),1)},v=function(e){t.$log.info("Adding element",e),n.push(e)},x=function(){c.holdingCTRL=!1},w=function(e){var t=e.keyCode||e.charCode;46!==t&&8!==t||null===c.reference?c.holdingCTRL=17===t:(m(c.reference.clearAllLinks()),c.reference=null)},y=function(r){r=r||e.event;for(var i=0;i<n.length;i++)n[i].existsIn(h.getX(r),h.getY(r))&&(c.reference=n[i]);var o=c.holdingCTRL===!0?c.dragTypes.linking:r.which;return null!==c.reference&&(c.originalBorder=c.reference.border,c.reference.border=(c.dragType=o)===c.dragTypes.moving?c.border.whenMoving:c.border.whenLiking,t.$log.info("Dragging element",{r:c.reference,d:o})),r.preventDefault?r.preventDefault():r.returnValue&&(r.returnValue=!1),!1},p=function(){null===s&&(d=(s=document.getElementById(o.targetCanvasId)).getContext("2d"),s.addEventListener("mousedown",y,!1),e.addEventListener("mousemove",f,!1),e.addEventListener("mouseup",g,!1),e.addEventListener("keydown",w,!1),e.addEventListener("keyup",x,!1),s.addEventListener("contextmenu",function(e){return e.preventDefault(),!1},!1)),d.clearRect(0,0,s.width,s.height);for(var t=0;t<n.length;t++)a(n[t])},b=function(e,t){for(var n,r=[],i=0;i<e.length;i++)n=e[i],t!==n&&r.push({name:n.name,childs:b(n.getChildElements().slice(),t||n),links:b(n.getLinksTo().slice(),t||n)});return r};return{addElement:function(e){v(e)},getDataUrl:function(){return s.toDataURL()},getElements:function(){return b(n)},initializeTimedDrawing:function(){l===!1&&(l=!0,u())}}}(),s={newLabel:function(){return t.$obj.extend(new i.label,{})},newSquare:function(){return t.$obj.extend(new i.square,{})},newCircle:function(){return t.$obj.extend(new i.circle,{})},plot:function(e){return l.addElement(e),s},exportImage:function(){var e=window.open();e.document.write("<img src='"+l.getDataUrl()+"'>")},getElements:function(){return l.getElements()},installUsing:function(e){return o=t.$obj.extend(i.library,e),l.initializeTimedDrawing(),s}};e.raska=s}(window);